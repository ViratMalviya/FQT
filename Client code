
#client.py for all the 3 client pcs

import os
import torch
import requests
from torch.utils.data import DataLoader, TensorDataset
import torch.nn as nn
from model import *

SERVER_URL = "http://192.168.1.10:5000"   # CHANGE THIS

def load_local_data():
    X, y = [], []
    for label, folder in [(0,"REAL"), (1,"FAKE")]:
        path = os.path.join("data", folder)
        for f in os.listdir(path):
            mfcc = extract_mfcc(os.path.join(path, f))
            X.append(mfcc)
            y.append(label)
    return torch.tensor(X), torch.tensor(y)

# Get global model
r = requests.get(f"{SERVER_URL}/get_model")
open("global.pt","wb").write(r.content)

gen = QuantumTrainGenerator(TargetCNN())
gen.load_state_dict(torch.load("global.pt"))

cnn = TargetCNN()
opt = torch.optim.Adam(gen.parameters(), lr=0.01)
loss_fn = nn.CrossEntropyLoss()

X, y = load_local_data()
loader = DataLoader(TensorDataset(X,y), batch_size=4, shuffle=True)

base = {k:v.clone() for k,v in gen.state_dict().items()}

for data, labels in loader:
    opt.zero_grad()
    params = gen(data)
    set_target_model_params(cnn, params)
    out = cnn(data)
    loss = loss_fn(out, labels)
    loss.backward()
    opt.step()

update = {k: gen.state_dict()[k] - base[k] for k in base}

torch.save(update, "update.pt")
requests.post(f"{SERVER_URL}/send_update", files={"update": open("update.pt","rb")})
print("Client update sent")




